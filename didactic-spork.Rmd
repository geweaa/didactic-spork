---
title: "didactic-spork (P26201 - cultures)"
author: "George"
date: '2022-07-12'
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: spacelab
    highlight: textmate
    df_print: paged
    code_folding: hide
    self_contained: false
    keep_md: false
    encoding: "UTF-8"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(tidyverse)
```


```{r themes}
source("/Users/geweaa/Box Sync/Protocols/theme.R")
source("/Users/geweaa/Box Sync/Protocols/barplot.R")
```


```{r files}
seqtab <- read_tsv("ASV_table.tsv", col_types = cols(.default = col_character(), count = col_integer())) %>%
  group_by(sample) %>% mutate(relab = count/sum(count)) %>% ungroup() # Add relative abundance
  
tax <- read_tsv("tax.P21015.P26201.tsv", col_types = cols(.default = col_character()))
smd <- read_tsv("smd.P21015.P26201.tsv", col_types = cols(.default = col_character())) 
```


```{r select cultures}
seqtab %>%
  inner_join(smd, by = "sample") %>%
  filter(!is.na(medium)) %>%
  select(sample, seqid, count, relab) -> seqtab
```


```{r rarefaction}
seqtab %>%
  inner_join(smd, by = "sample") %>% filter(groundwater == "KR0015B") %>%
  select(sample, seqid, count) %>%
  spread(seqid, count, fill = 0) %>%
  column_to_rownames('sample') -> seqtab_matrix
  
png(filename = "figures/rarecurve_meteoric.png", width = 14, height = 10, units = "cm", res = 300)  
min(rowSums(seqtab_matrix)) %>%
vegan::rarecurve(seqtab_matrix, 
                 sample = ., step = 100, cex = 0.5, cex.axis = 0.6, cex.lab = 0.6, 
                 xlab = 'Sequencing depth KR0015B', 
                 ylab = 'Rarefied No. of ASVs', label = TRUE)
dev.off()


seqtab %>%
  inner_join(smd, by = "sample") %>% filter(groundwater == "SA1420A-1") %>%
  select(sample, seqid, count) %>%
  spread(seqid, count, fill = 0) %>%
  column_to_rownames('sample') -> seqtab_matrix
  
png(filename = "figures/rarecurve_mm.png", width = 14, height = 10, units = "cm", res = 300)  
min(rowSums(seqtab_matrix)) %>%
vegan::rarecurve(seqtab_matrix, 
                 sample = ., step = 100, cex = 0.5, cex.axis = 0.6, cex.lab = 0.6, 
                 xlab = 'Sequencing depth SA1420A-1', 
                 ylab = 'Rarefied No. of ASVs', label = TRUE)
dev.off()



seqtab %>%
  inner_join(smd, by = "sample") %>% 
  filter(groundwater %in% c("KA3511A-1","SA2600A-1","KA2862A-1")) %>%
  select(sample, seqid, count) %>%
  spread(seqid, count, fill = 0) %>%
  column_to_rownames('sample') -> seqtab_matrix
  
png(filename = "figures/rarecurve_os.png", width = 14, height = 10, units = "cm", res = 300)  
min(rowSums(seqtab_matrix)) %>%
vegan::rarecurve(seqtab_matrix, 
                 sample = ., step = 100, cex = 0.5, cex.axis = 0.6, cex.lab = 0.6, 
                 xlab = 'Sequencing depth SA2600, KA3511 & KA2862', 
                 ylab = 'Rarefied No. of ASVs', label = TRUE)
dev.off()
```



```{r lollipop mm}
seqtab %>%
  inner_join(smd, by = "sample") %>%
  filter(groundwater == "SA1420A-1") %>%
  inner_join(taxref, by = "seqid") %>%
  group_by(sample, rank) %>% summarise(relab = sum(relab), .groups = "drop_last") %>%
  slice_max(order_by = relab, n = 1) %>% ungroup() %>%
  mutate(relab = round(relab, digits = 2) * 100) %>%
  mutate(i = paste(rank, " (", relab, "%)", sep = "")) %>%
  mutate(hjust = if_else(relab >= 50, 1.05, -0.07)) -> plotlab
  
plotlab %>%
  inner_join(smd, by = "sample") %>%
  arrange(desc(relab)) %>%
  ggplot(aes(x = fct_reorder(id, relab), y = relab)) +
  geom_segment(aes(xend = id, y = 0, yend = relab), color = "grey", size = 0.1) +
  geom_point(stroke = 0.8, size = 1, fill = "white", shape = 21) +
  geom_text(aes(label = i, hjust = hjust), 
            color = "black", size = 2) +
  scale_y_continuous(limits = c(0, 100)) +
  coord_flip() +
  labs(x = "", y = "Relative abundance (%)") +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        aspect.ratio = 1.6,
        axis.text.x = element_text(size = 7, color = "black"),
        axis.text.y = element_text(size = 7, color = "black"),
        strip.text = element_text(size = 7, color = "black"),
        axis.title.x.bottom = element_text(size = 7, color = "black"),
        strip.background = element_blank(),
        axis.ticks.x = element_blank(),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_line(colour = "grey"))
```


```{r export lollipop mm}
ggsave(filename = "lollipop.png", width = 14, height = 12, units = c("cm"))
```


#### Alpha diversity ####


```{r alpha diversity}
seqtab %>%
  select(-relab) %>%
  spread(seqid, count, fill = 0) %>% 
  column_to_rownames('sample') %>%
  vegan::diversity() %>% as.data.frame() %>%
  rownames_to_column('sample') %>%
  rename(shannon = 2) %>%
  inner_join(smd, by = "sample") -> adiv
```


```{r plot alpha diversity}
specno %>%
  mutate(groundwater = gsub("A-1", "", groundwater)) %>%
  ggplot(aes(x = specno, y = fct_relevel(groundwater, 
                                          c("SA2600","KA3511","KA2862","KA2511","SA1420","SA1229","KR0015B")
                                          ))) + 
  geom_boxplot(outlier.color = "white") +
  geom_point(aes(color = fraction), stroke = 0.8, size = 2, fill = "white", shape = 21) +
  labs(x = "Alpha diversity (Estimated No. ASVs)", y = "") +
  theme_tidy() +
  scale_color_manual(name = "Size fraction inoculum", 
                     labels = c("> 0.1 µm","0.1 - 0.45 µm"), 
                     values = c(unfiltered = "black", filtered = "#e31a1c")) +
  theme(legend.title = element_text(size = 6, face = "bold"),
        legend.position = c(0.75, 0.2),
        legend.box.background = element_rect(color = 'black', size = 0.5),
        axis.text.x = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        plot.background = element_rect(fill = "white"),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(),
        axis.line.y.left = element_line(),
        panel.grid.major.x = element_line(colour = "grey", linetype = "dotted", size = 0.4))
```


```{r export alphadiv}
ggsave(filename = "figures/adiv.png", width = 8, height = 8, units = c("cm"))
```


```{r specnumber}
seqtab %>%
  select(-relab) %>%
  spread(seqid, count, fill = 0) %>% 
  column_to_rownames('sample') %>%
  vegan::specnumber() %>% as.data.frame() %>%
  rownames_to_column('sample') %>%
  rename(specno = 2) %>%
  inner_join(smd, by = "sample") %>% tibble() -> specno
```


```{r plot specnumber}
specno %>%
  mutate(groundwater = gsub("A-1", "", groundwater)) %>%
  filter(fraction != "filtered") %>%
  mutate(sample = paste(groundwater, medium)) %>%
  ggplot(aes(x = fct_reorder(sample, specno), y = specno)) + 
  geom_segment(aes(xend = sample, y = 0, yend = specno), color = "black", size = 0.3) +
  geom_point(stroke = 0.8, size = 2, fill = "white", shape = 21) +
  labs(x = "", y = "Estimated species number") +
  coord_flip() +
  theme_tidy() +
  scale_y_continuous(expand = c(0,2), limits = c(0,1500)) +
  theme(aspect.ratio = 1.2,
        axis.ticks.length = unit(-0.12, "cm"),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_line(colour = "grey", linetype = "dotted", size = 0.4))
```


```{r export lollipop meteoric}
ggsave(filename = "lollipop_specnumber.png", width = 14, height = 12, units = c("cm"))
```


#### Cultures of special interest ####


```{r lollipop interest}
i <- c(
"srm 10/2021 (07)","lys 10/2021 (09)","srm 10/2021 (10)","srm 10/2021 (26)","srm 10/2021 (27)",
"ace 10/2021 (32)","srm 10/2021 (33)","srm 10/2021 (34)","lys 02/2021 (37)","lys 02/2021 (38)",
"met 10/2021 (44)","met 10/2021 (45)","lys 10/2021 (54)","lys 10/2021 (55)",
"srm 10/2021 (57)","srm 03/2022 (61)","srm 03/2022 (62)","srm 03/2022 (63)","lys 03/2022 (68)",
"lys 03/2022 (69)","srm 03/2022 (70)","srm 03/2022 (71)","srm 03/2022 (72)","lys 03/2022 (73)",
"lys 03/2022 (74)","lys 03/2022 (75)","srm 03/2022 (77)","srm 03/2022 (78)","lys 03/2022 (79)",
"lys 03/2022 (80)","lys 03/2022 (81)"
)

seqtab %>%
  inner_join(smd, by = "sample") %>%
  filter(id %in% i) %>%
  inner_join(tax, by = "seqid") %>%
  mutate(taxon = coalesce(genus,family,order)) %>%
  group_by(sample, id, taxon) %>% summarise(relab = sum(relab) * 100, .groups = "drop_last") %>%
  slice_max(order_by = relab, n = 1) %>% ungroup() %>%
  mutate(i = paste(taxon, " (", round(relab, digits = 1), "%)", sep = "")) %>%
  mutate(hjust = if_else(relab >= 70, 1.05, -0.07)) -> plotlab
  
plotlab %>%
  ggplot(aes(x = fct_reorder(id, relab), y = relab)) +
  geom_segment(aes(xend = id, y = 30, yend = relab), color = "black", size = 0.1) +
  geom_point(stroke = 0.8, size = 1, fill = "white", shape = 21) +
  geom_label(aes(label = i, hjust = hjust), 
            color = "black", 
            fontface = "bold", 
            size = 1.6, 
            label.size = 0.1, 
            label.padding = unit(0.10, "lines")) +
  coord_flip() +
  scale_y_continuous(expand = c(0.004,0), limits = c(30,100)) +
  labs(x = "Enrichtment culture", y = "Relative abundance (%)") +
  theme_tidy() +
  theme(aspect.ratio = 2,
        plot.margin = margin(4,8,4,0),
        axis.text.x.bottom = element_text(face = "bold"),
        axis.title = element_text(face = "bold"),
        axis.ticks.length = unit(0.12, "cm"),
        panel.border = element_blank(),
        axis.line.x.bottom = element_line(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_line(colour = "grey", linetype = "dotted", size = 0.4)) -> p1
```


```{r barplot interest order}
seqtab %>%
  inner_join(smd, by = "sample") %>%
  filter(id %in% i) %>%
  inner_join(tax, by = "seqid") %>%
  group_by(class, sample) %>%
  # Sum the abundance of each phylum within a sample
  summarise(relab = sum(relab), .groups = 'drop_last') %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(relab), .groups = 'drop') %>%
  filter(!is.na(class)) %>%
  top_n(11, mean_relab) -> t

tax %>%
  left_join(t %>% transmute(class, topphylum = class), by = "class") %>%
  replace_na(list("topphylum" = "Other")) %>%
  mutate(rank = coalesce(genus, family, order, class))-> taxref

seqtab %>%
  inner_join(taxref, by = "seqid") %>% 
  # Summarize in order to have the sum for each category and topphylum
  group_by(topphylum, sample) %>% 
  summarise(mrelab = sum(relab), .groups = 'drop') %>%
  inner_join(plotlab, by = "sample") %>%
  # Call the plot
  ggplot(aes(x = fct_reorder(id, relab), 
             y = mrelab, 
             fill = fct_relevel(topphylum, c("Other")))) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col() +
  scale_fill_brewer(palette = 'Paired') +
  coord_flip() + 
  scale_y_continuous(trans = 'reverse', labels = c('100','','50','','0'), expand = c(0.004,0)) +
  theme_barplot() + 
  theme(aspect.ratio = 3, 
        axis.text.y = element_blank(),
        axis.line.x.bottom = element_line(),
        plot.margin = margin(4,4,4,0),
        axis.text.x = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = "right",
        legend.text = element_text(size = 6, color = "black"),
        legend.key.size = unit(3, "mm")) -> p2
```


```{r patch interest}
library(patchwork)

p1 + p2 
```


```{r export patchwork interest}
ggsave(filename = "figures/interest.png", width = 14, height = 10, units = c("cm"))
```


```{r}
seqtab %>% 
  inner_join(tax, by = "seqid") %>% 
  filter(phylum == "Patescibacteria" | phylum == "Nanoarchaeota") %>% 
  group_by(sample) %>% summarise(i = sum(relab)) %>% 
  slice_max(i, n = 20) %>% pull(sample) -> i

seqtab %>%
  filter(sample %in% i) %>%
  inner_join(smd, by = "sample") %>%
  inner_join(tax, by = "seqid") %>%
  filter(phylum == "Patescibacteria" | phylum == "Nanoarchaeota") %>% 
  group_by(sample, id, taxon) %>% summarise(relab = sum(relab) * 100, .groups = "drop_last") %>%
  slice_max(relab, n = 1) %>% ungroup() %>%
  mutate(i = paste(taxon, " (", round(relab, digits = 1), "%)", sep = "")) %>%
  mutate(hjust = if_else(relab >= 70, 1.05, -0.07)) -> plotlab
  
plotlab %>%
  inner_join(smd, by = c("sample","id")) %>%
  mutate(id = paste(
    substr(groundwater, 1,6), " ", 
    medium, " (",  
    substr(fraction, 1,1), ")",
    sep = "")
    ) %>%
  mutate(sample = gsub("P26201_10","",sample)) %>%
  ggplot(aes(x = fct_reorder(sample, relab), y = relab)) +
  geom_segment(aes(xend = sample, y = 0, yend = relab), color = "black", size = 0.1) +
  geom_point(stroke = 0.8, size = 1, fill = "white", shape = 21) +
  geom_label(aes(label = i, hjust = hjust), 
            color = "black", 
            fontface = "bold", 
            size = 2, 
            label.size = 0.1, 
            label.padding = unit(0.10, "lines")) +
  coord_flip(clip = "off") +
  scale_x_discrete(labels = c(
    "11" = "SA1420 ace (u)", "12" = "SA1420 ace (f)",
    "67" = "KR0015 lys (f)", "36" = "SA1420 lys (f)",
    "29" = "SA1420 lys (f)", "68" = "KR0015 lys (f)",
    "25" = "SA1420 ace (f)", "17" = "SA1420 ana (u)",
    "82" = "SA1420 lys (f)", "76" = "SA1420 srm (u)", 
    "83" = "SA1420 lys (f)", "30" = "SA2600 srm (u)",
    "31" = "SA2600 srm (u)", "16" = "SA1229 ana (u)",
    "13" = "SA1229 ana (u)", "57" = "SA1420 srm (f)",
    "14" = "KA2511 ana (u)", "78" = "KA2511 ana (u)",
    "32" = "SA1420 ace (u)", "34" = "SA1420 srm (f)")
  ) +
  scale_y_continuous(expand = c(0.004,0), limits = c(0,25)) +
  labs(x = "", y = "Relative abundance (%)") +
  theme_tidy(fontsize = 7) +
  theme(aspect.ratio = 2,
        axis.text.y.left = element_text(face = "plain", family = "Courier New"),
        plot.margin = margin(4,8,4,0),
        axis.text.x.bottom = element_text(face = "bold"),
        axis.title = element_text(face = "bold"),
        panel.border = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_line(colour = "grey", linetype = "dotted", size = 0.4)) -> p1
```


```{r}
seqtab %>%
  filter(sample %in% i) %>%
  inner_join(smd, by = "sample") %>%
  inner_join(tax, by = "seqid") %>%
  group_by(sample, id, taxon) %>% summarise(relab = sum(relab) * 100, .groups = "drop_last") %>%
  slice_max(relab, n = 1) %>% ungroup() %>%
  mutate(i = paste(taxon, " (", round(relab, digits = 1), "%)", sep = "")) %>%
  mutate(hjust = if_else(relab >= 50, 1.05, -0.07)) -> plotlab
  
plotlab %>%
  inner_join(smd, by = c("sample","id")) %>%
  mutate(id = paste(
    substr(groundwater, 1,6), " ", 
    medium, " (",  
    substr(fraction, 1,1), ")",
    sep = "")
    ) %>%
  mutate(sample = gsub("P26201_10","",sample)) %>%
  ggplot(aes(x = fct_rev(fct_relevel(sample,c(
    "11", "12",
    "67", "36",
    "29", "68",
    "25", "17",
    "82", "76", 
    "83", "30",
    "31", "16",
    "13", "57",
    "14", "78",
    "32", "34")
    )), 
    y = relab)) +
  geom_segment(aes(xend = sample, y = 0, yend = relab), color = "black", size = 0.1) +
  geom_point(stroke = 0.8, size = 1, fill = "white", shape = 21) +
  geom_label(aes(label = i, hjust = hjust), 
            color = "black", 
            fontface = "bold", 
            size = 2, 
            label.size = 0.1, 
            label.padding = unit(0.10, "lines")) +
  coord_flip(clip = "off") +
  scale_y_continuous(expand = c(0.004,0), limits = c(0,100)) +
  labs(x = "", y = "Relative abundance (%)") +
  theme_tidy(fontsize = 7) +
  theme(aspect.ratio = 2,
        axis.text.y.left = element_blank(),
        plot.margin = margin(4,8,4,0),
        axis.text.x.bottom = element_text(face = "bold"),
        axis.title = element_text(face = "bold"),
        panel.border = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_line(colour = "grey", linetype = "dotted", size = 0.4)) -> p2
```



```{r}
cols <- c(
  "Actinomycetia" = "#a6cee3",
  "Bacteroidia" = "#1f78b4",
  "Dehalococcoidia" = "#b2df8a",
  "Bacilli" = "#33a02c",
  "Clostridia" = "#fb9a99",
  "Nanoarchaeia" = "#e31a1c",
  "Kol11" = "#fdbf6f",
  "ABY1" = "#ff7f00",
  "Paceibacteria" = "#cab2d6",
  "Alphaproteobacteria" = "#6a3d9a",
  "Gammaproteobacteria" = "#ffff99",
  "Other" = "#b15928"
)


seqtab %>%
  filter(sample %in% i) %>%
  inner_join(tax, by = "seqid") %>%
  group_by(class, sample) %>%
  # Sum the abundance of each phylum within a sample
  summarise(relab = sum(relab), .groups = 'drop_last') %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(relab), .groups = 'drop') %>%
  filter(!is.na(class)) %>%
  top_n(11, mean_relab) -> t

tax %>%
  left_join(t %>% transmute(class, topphylum = class), by = "class") %>%
  replace_na(list("topphylum" = "Other")) -> taxref

seqtab %>%
  inner_join(taxref, by = "seqid") %>%
  mutate(label = if_else(topphylum != "Other", 
                         paste0(topphylum," (",phylum,")"), 
                         topphylum)
         ) %>%
  # Summarize in order to have the sum for each category and topphylum
  group_by(label, sample) %>% 
  summarise(mrelab = sum(relab), .groups = 'drop') %>%
  inner_join(plotlab, by = "sample") %>%
  mutate(sample = gsub("P26201_10","",sample)) %>%
  # Call the plot
  ggplot(aes(x = fct_rev(fct_relevel(sample,c(
    "11", "12",
    "67", "36",
    "29", "68",
    "25", "17",
    "82", "76", 
    "83", "30",
    "31", "16",
    "13", "57",
    "14", "78",
    "32", "34")
    )),  
             y = mrelab, 
             fill = fct_relevel(label, c("Actinomycetia (Actinobacteriota)",
                                         "Bacteroidia (Bacteroidota)",
                                         "Dehalococcoidia (Chloroflexota)",
                                         "Bacilli (Firmicutes)",
                                         "Clostridia (Firmicutes)",
                                         "Nanoarchaeia (Nanoarchaeota)",
                                         "Koll11 (Omnitrophota)",
                                         "ABY1 (Patescibacteria)",
                                         "Paceibacteria (Patescibacteria)",
                                         "Alphaproteobacteria (Proteobacteria)",
                                         "Gammaproteobacteria (Proteobacteria)",
                                         "Other")))) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col() +
  scale_fill_brewer(palette = 'Paired') +
  coord_flip() + 
  scale_y_continuous(trans = 'reverse', labels = c('100','','50','','0'), expand = c(0.004,0)) +
  theme_barplot(fontsize = 7) + 
  #guides(fill = guide_legend(nrow = 12)) +
  theme(aspect.ratio = 2,
        axis.text.y = element_blank(),
        plot.margin = margin(4,4,4,0),
        axis.text.x = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = "right",
        legend.text = element_text(size = 7, color = "black"),
        legend.key.size = unit(3, "mm")) -> p3
```


```{r patch interest}
library(patchwork)

p1 + p2 + p3
```

```{r export patchwork interest}
ggsave(filename = "figures/patesci.png", width = 22, height = 12, units = c("cm"))
```



```{r}
seqtab %>%
  inner_join(tax, by = "seqid") %>%
  filter(sample %in% interest) %>%
  group_by(phylum,sample) %>%
  # Sum the abundance of each phylum within a sample
  summarise(relab = sum(relab), .groups = 'drop_last') %>%
  # Calculate the mean abundance of each phylum over the categories
  summarise(mean_relab = sum(relab), .groups = 'drop') %>%
  filter(!is.na(phylum)) %>%
  top_n(11, mean_relab) -> t

tax %>%
  left_join(t %>% transmute(phylum, topphylum = phylum), by = "phylum") %>%
  replace_na(list("topphylum" = "Other")) -> taxref

seqtab %>%
  filter(sample %in% interest) %>%
  inner_join(taxref, by = "seqid") %>%
  # Summarize in order to have the sum for each category and topphylum
  group_by(topphylum, sample) %>% 
  summarise(mrelab = sum(relab), .groups = 'drop') %>%
  # Call the plot
  ggplot(aes(x = sample %>% fct_rev(),
             y = mrelab, 
             fill = fct_relevel(topphylum, c("Other"), after = 11) 
                        )
         ) +
  labs(x = '', y = 'Relative abundance (%)') +
  geom_col() +
  coord_flip() +
  scale_fill_brewer(palette = 'Paired') +
  scale_y_continuous(trans = 'reverse', labels = c('100','75','50','25','0'), expand = c(0.004,0)) +
  theme_barplot(fontsize = 7) + 
  #guides(fill = guide_legend(nrow = 12)) +
  theme(aspect.ratio = 2,
        plot.margin = margin(4,4,4,0),
        axis.text.x = element_text(face = "bold"),
        axis.title.x = element_text(face = "bold"),
        legend.position = "right",
        legend.text = element_text(size = 7, color = "black"),
        legend.key.size = unit(3, "mm")) #-> p3
```

